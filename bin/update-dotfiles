#!/bin/bash
set -e

nvimVersion="0.3.4"

# {{{
# Print the progress and heading
PROGRESS=0
PROGRESS_TOTAL=6
progress() {
    PROGRESS=$(($PROGRESS + 1))
    echo -e "\033[0;32m[$PROGRESS/$PROGRESS_TOTAL] $1\033[0;0m"
}

# Print a command and then run it
print_run() {
    echo -e "\033[0;36m>> $1\033[0;0m"
    eval "$1"
}

mkdir -p ~/dotfiles/tools
PATH="~/bin:~/dotfiles/bin:$PATH"
# }}}
# Check for our dependencies {{{
progress "Checking for dependencies"

command -v find >/dev/null || {
	echo "Please install find"
	depExit=1
}

command -v git >/dev/null || {
	echo "Please install git"
	depExit=1
}

if [ ! -z "$depExit" ]; then
	exit 1
fi
# }}}
# Update repo and tmp {{{
progress "Pulling"
if [ -z "$NO_PULL" ]; then
	cd ~/dotfiles
	current_revision="$(sha1sum bin/update-dotfiles)"
	print_run "git checkout -f master"
	print_run "git pull"
	chmod +x ~/dotfiles/bin/*
	
	if [ "$current_revision" != "$(sha1sum bin/update-dotfiles)" ]; then
		exec ~/dotfiles/bin/update-dotfiles
	fi
	
	if [ -d .tmux/plugins/tpm ]; then
		pushd .tmux/plugins/tpm
		print_run "git checkout master"
		print_run "git pull"
		popd
	else
		print_run "git clone https://github.com/tmux-plugins/tpm .tmux/plugins/tmp"
	fi
else
	echo "Not pulling because the env var NO_PULL is set"
fi
# }}}
# Install links {{{
cd ~/dotfiles
progress "Installing symlinks"

KEEP_DOTFILES=1 ~/dotfiles/bin/cleanup-dotfiles >/dev/null

for file in $(ls -1a | tail -n $(($(ls -1a | wc -l) - 2)) | fgrep -v .git | fgrep -v bin | fgrep -v README.md | fgrep -v tools); do
    if [ -f ~/$file ]; then
        print_run "mv ~/$file ~/$file.bak"
    fi

    ln -s ~/dotfiles/$file ~/$file
done

mkdir -p ~/bin
# }}}
# Install nvim {{{
progress "Installing nvim"

if [ -f ~/dotfiles/tools/nvim/bin/nvim ]; then
	curNvim="$(~/dotfiles/tools/nvim/bin/nvim --version | head -1 | grep -o "[0-9]*\.[0-9]*\.[0-9]*")"
fi

if [ "$curNvim" != "$nvimVersion" ]; then
	nvimTmp=$(mktemp -d)
	nvimTmpCleanup() {
		rm -rf $nvimTmp
	}
	trap nvimTmpCleanup EXIT

	pushd $nvimTmp
	wget https://github.com/neovim/neovim/releases/download/v$nvimVersion/nvim-linux64.tar.gz
	tar xf nvim-linux64.tar.gz
	popd
	rm -rf ~/dotfiles/tools/nvim
	mv $nvimTmp/nvim-linux64 ~/dotfiles/tools/nvim
fi

rm -rf ~/bin/nvim
ln -s ~/dotfiles/tools/nvim/bin/nvim ~/bin/nvim
# }}}
# Install app plugins {{{
progress "Installing app plugins"

command -v tmux >/dev/null && {
	export TMUX_PLUGIN_MANAGER_PATH="$HOME/.tmux/plugins/"
	~/dotfiles/.tmux/plugins/tpm/scripts/install_plugins.sh
} || echo "Tmux not found. skipping."

command -v wget >/dev/null && hasWget=1
command -v curl >/dev/null && hasCurl=1
plugReady=1

if [ ! -z "$hasWget" ]; then
	mkdir -p ~/.local/share/nvim/site/autoload
		wget -qO ~/.local/share/nvim/site/autoload/plug.vim \
	    	https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
elif [ ! -z "$hasCurl" ]; then
	curl -s -fLo ~/.local/share/nvim/site/autoload/plug.vim --create-dirs \
			https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
else
	echo "Could not find curl or wget. skipping vim."
	unset plugReady
fi

if [ ! -z "$plugReady" ]; then
	nvim +PlugClean +PlugInstall +qall 2>/dev/tty >/dev/tty </dev/tty
fi

# Configure nvim to use the vim config
rm -f ~/.local/share/nvim/site/.vim
ln -s ~/.vim ~/.local/share/nvim/site/.vim

mkdir -p ~/.config/nvim
cat >~/.config/nvim/init.vim <<"EOF"
set runtimepath^=~/.vim runtimepath+=~/.vim/after
let &packpath = &runtimepath
source ~/.vimrc
EOF
# }}}
# Configure git {{{
progress "Configure git"
git config --global alias.co checkout
git config --global alias.undo "reset --soft HEAD~1"
git config --global alias.lg "log --format=\\\"%C(yellow)%h%Creset %C(cyan)%an%Creset %s\\\""
git config --global alias.l1 "log -1 --format=\\\"%C(yellow)%h%Creset %C(cyan)%an%Creset %s\\\""
git config --global alias.tree "log --format=\\\"%C(yellow)%h%Creset %C(cyan)%an%Creset %s\\\" --graph --all"
# }}}
