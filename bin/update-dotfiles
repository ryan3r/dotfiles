#!/bin/bash
set -e

# {{{
# Print the progress and heading
PROGRESS=0
PROGRESS_TOTAL=5
progress() {
    PROGRESS=$(($PROGRESS + 1))
    echo -e "\033[0;32m[$PROGRESS/$PROGRESS_TOTAL] $1\033[0;0m"
}

# Print a command and then run it
print_run() {
    echo -e "\033[0;36m>> $1\033[0;0m"
    eval "$1"
}
# }}}
# Check for our dependencies {{{
DEPS_NEEDED=
progress "Checking for and installing dependencies"

for dep in "vim" "tmux" "find" "git" "curl"; do
    command -v $dep >/dev/null || {
        if [ -z "$DEPS_NEEDED" ]; then
            DEPS_NEEDED="$dep"
        else
            DEPS_NEEDED="$DEPS_NEEDED, $dep"
        fi
    }
done

# Install deps if root or tell the user if to do it
if [ ! -z "$DEPS_NEEDED" ]; then
    echo "Please install $DEPS_NEEDED and then rerun this script"
	exit 1
fi
# }}}
# Update repo and submodules {{{
progress "Pulling"
cd ~/dotfiles
current_revision="$(sha1sum bin/update-dotfiles)"
print_run "git checkout -f master"
print_run "git pull"
chmod +x ~/dotfiles/bin/*

if [ "$current_revision" != "$(sha1sum bin/update-dotfiles)" ]; then
	exec ~/dotfiles/bin/update-dotfiles
fi

progress "Updating submodules"
print_run "git submodule init"
print_run "git submodule update"
# }}}
# Install links {{{
cd ~/dotfiles
progress "Installing symlinks"

KEEP_DOTFILES=1 ~/dotfiles/bin/cleanup-dotfiles

for file in $(ls -1a | tail -n $(($(ls -1a | wc -l) - 2)) | fgrep -v .git | fgrep -v bin | fgrep -v README.md); do
    if [ -f ~/$file ]; then
        print_run "mv ~/$file ~/$file.bak"
    fi

    ln -s ~/dotfiles/$file ~/$file
done

mkdir -p ~/bin

for file in $(ls -1 bin); do
    if [ -f ~/bin/$file ]; then
        echo "Moving existing bin/$file to bin/$file.bak"
        mv ~/bin/$file ~/bin/$file.bak
    fi

    ln -s ~/dotfiles/bin/$file ~/bin/$file
done
# }}}
# Install app plugins {{{
progress "Installing app plugins"

export TMUX_PLUGIN_MANAGER_PATH="$HOME/.tmux/plugins/"
~/.tmux/plugins/tpm/scripts/install_plugins.sh

curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
	    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim

vim +PlugInstall +qall 2>/dev/tty >/dev/tty </dev/tty
# }}}
